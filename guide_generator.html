<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligenter RXPGuides Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section h2 { margin-top: 0; color: #333; }
        textarea { width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #ccc; padding: 10px; }
        .output-area { height: 400px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:hover { background: #005a87; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .example-text { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 11px; }
        .stats { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 4px; }
        .flex-container { display: flex; gap: 20px; }
        .flex-item { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Intelligenter RXPGuides Generator</h1>
        <p>Konvertiert komplexe Guide-Texte automatisch in Lua-Format f√ºr RXPGuides_MVS</p>
        
        <div class="section">
            <h2>üìù Guide Text Input</h2>
            <div class="warning">
                <strong>Unterst√ºtzte Formate:</strong><br>
                ‚Ä¢ Turn in "Quest Name" , accept Next Quest.<br>
                ‚Ä¢ Accept [Quest Name] from [NPC Name].<br>
                ‚Ä¢ Turn in "Quest" to [NPC], accept [Next Quest].<br>
                ‚Ä¢ Kill 15 [Mob Name] at 61.58.<br>
                ‚Ä¢ At 35.42 enter location.
            </div>
            
            <div class="example-text">
<strong>Beispiel:</strong>
Turn in "Fire Taboo" , accept Blisters on The Land.
Accept [Daily Delivery] from [Einar Stonegrip].
Turn in "The Greenwarden" to [Rethiel the Greenwarden], accept [Tramping Paws].
Kill 15 [Mosshide Gnolls] at 61.58.
At 35.42 enter the Whelgar's Excavation Site.
Go up and turn in "Ormer's Revenge", accept the next part.
            </div>
            
            <textarea id="guide-input" placeholder="F√ºgen Sie hier den Guide-Text ein..."></textarea>
            <br>
            <button onclick="parseGuideText()">üîç Guide Text parsen</button>
            <button onclick="loadExample()">üìã Beispiel laden</button>
            <button onclick="clearInput()">üóëÔ∏è Leeren</button>
        </div>

        <div class="flex-container">
            <div class="flex-item">
                <div class="section">
                    <h2>üìä Parsing Ergebnisse</h2>
                    <div id="stats" class="stats"></div>
                    <div id="quest-preview" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <div class="flex-item">
                <div class="section">
                    <h2>‚ö†Ô∏è Fehlende Quest-Daten</h2>
                    <div id="missing-quests" style="max-height: 300px; overflow-y: auto;"></div>
                    <button onclick="addMissingQuest()">‚ûï Quest hinzuf√ºgen</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üéØ Generierter Lua Code</h2>
            <button onclick="generateLua()" class="btn-success">üöÄ Lua Code generieren</button>
            <button onclick="exportGuide()">üíæ Als .lua Datei exportieren</button>
            <button onclick="copyToClipboard()">üìã In Zwischenablage kopieren</button>
            <textarea id="lua-output" class="output-area" readonly></textarea>
        </div>
    </div>

    <script>
        let parsedSteps = [];
        let missingQuests = new Set();

        // Erweiterte Quest-Datenbank
        const questDatabase = {
            "Claws from the Deep": {quest: 279, npc: "Karl Boran"},
            "Young Crocolisk Skins": {quest: 484, npc: "James Halloran"},
            "The Third Fleet": {quest: 288, npc: "First Mate Fitzsimmons"},
            "The Greenwarden": {quest: 463, npc: "First Mate Fitzsimmons"},
            "The Absent Minded Prospector": {quest: 942, npc: "Archaeologist Flagongut"},
            "The Cursed Crew": {quest: 289, npc: "First Mate Fitzsimmons"},
            "Digging Through the Ooze": {quest: 470, npc: "Sida"},
            "Report to Captain Stoutfist": {quest: 473, npc: "Valstag Ironjaw"},
            "War Banners": {quest: 464, npc: "Captain Stoutfist"},
            "Report From Stoutfist": {quest: 55204, npc: "Captain Stoutfist"},
            "In Search of The Excavation Team": {quest: 305, npc: "Tarrel Rockweaver"},
            "Ormer's Revenge": {quest: 294, npc: "Ormer Ironbraid"},
            "Uncovering the Past": {quest: 299, npc: "Prospector Whelgar"},
            "Daily Delivery": {quest: 469, npc: "Einar Stonegrip"},
            "Tramping Paws": {quest: 276, npc: "Rethiel the Greenwarden"},
            "Fire Taboo": {quest: 277, npc: "Rethiel the Greenwarden"},
            "Blisters on The Land": {quest: 471, npc: "Rethiel the Greenwarden"},
            "Lifting the Curse": {quest: 290, npc: "First Mate Fitzsimmons"},
            "Apprentice's Duties": {quest: 471, npc: "Theldurin the Lost"},
            "Nek'Rosh's Gambit": {quest: 465, npc: "Captain Stoutfist"},
            "The Search Continues": {quest: 284, npc: "Archeologist Hollee"},
            "Search More Hovels": {quest: 285, npc: "Prospector Ironband"},
            "Return the Statuette": {quest: 286, npc: "Harlo Barnaby"},
            "Reclaiming Goods": {quest: 289, npc: "First Mate Fitzsimmons"}
        };

        const npcCoords = {
            "Karl Boran": {x: 8.3, y: 58.6},
            "James Halloran": {x: 8.5, y: 55.7},
            "First Mate Fitzsimmons": {x: 10.9, y: 59.6},
            "Innkeeper Helbrek": {x: 10.7, y: 60.9},
            "Archaeologist Flagongut": {x: 10.8, y: 60.4},
            "Sida": {x: 11.8, y: 58.0},
            "Valstag Ironjaw": {x: 10.1, y: 56.9},
            "Captain Stoutfist": {x: 9.9, y: 57.5},
            "Tarrel Rockweaver": {x: 11.5, y: 52.1},
            "Ormer Ironbraid": {x: 38.2, y: 50.9},
            "Merrin Rockweaver": {x: 38.9, y: 52.3},
            "Prospector Whelgar": {x: 38.8, y: 52.4},
            "Einar Stonegrip": {x: 49.9, y: 39.3},
            "Rethiel the Greenwarden": {x: 56.4, y: 40.4},
            "Theldurin the Lost": {x: 47.5, y: 46.9},
            "Archeologist Hollee": {x: 14.3, y: 38.1},
            "Prospector Ironband": {x: 14.3, y: 35.8},
            "Harlo Barnaby": {x: 10.1, y: 60.2}
        };

        function parseComplexLine(line) {
            const steps = [];
            
            // Multi-Action Pattern (Turn in + Accept)
            const multiPattern = /Turn in "([^"]+)"\s*,\s*accept\s+(.+?)(?:\.|$)/i;
            const multiMatch = line.match(multiPattern);
            
            if (multiMatch) {
                const turninQuest = multiMatch[1];
                let acceptQuest = multiMatch[2].replace(/[\[\]\.]/g, '').trim();
                
                // Turn in Step
                if (questDatabase[turninQuest]) {
                    const questData = questDatabase[turninQuest];
                    steps.push({
                        action: 'turnin',
                        quest: questData.quest,
                        name: turninQuest,
                        npc: questData.npc
                    });
                } else {
                    missingQuests.add(turninQuest);
                    steps.push({
                        action: 'turnin',
                        name: turninQuest,
                        note: `Quest data missing for: ${turninQuest}`
                    });
                }
                
                // Accept Step
                if (questDatabase[acceptQuest]) {
                    const questData = questDatabase[acceptQuest];
                    steps.push({
                        action: 'accept',
                        quest: questData.quest,
                        name: acceptQuest,
                        npc: questData.npc
                    });
                } else {
                    missingQuests.add(acceptQuest);
                    steps.push({
                        action: 'accept',
                        name: acceptQuest,
                        note: `Quest data missing for: ${acceptQuest}`
                    });
                }
            } else {
                // Einzelne Actions
                const acceptFromPattern = /Accept\s+\[?([^\]]+)\]?\s+from\s+\[?([^\]\.]+)\]?/i;
                const turninToPattern = /Turn in\s+"([^"]+)"\s+to\s+\[?([^\]\.]+)\]?/i;
                const acceptSimplePattern = /Accept\s+\[?([^\]\.]+)\]?/i;
                const turninSimplePattern = /Turn in\s+"([^"]+)"/i;
                const killPattern = /Kill\s+(?:\d+\s+)?\[?([^\]]+)\]?/i;
                
                let match;
                if ((match = line.match(acceptFromPattern))) {
                    const questName = match[1];
                    const npcName = match[2];
                    
                    const step = {
                        action: 'accept',
                        name: questName,
                        npc: npcName
                    };
                    
                    if (questDatabase[questName]) {
                        step.quest = questDatabase[questName].quest;
                    } else {
                        missingQuests.add(questName);
                        step.note = `Quest data missing for: ${questName}`;
                    }
                    
                    steps.push(step);
                } else if ((match = line.match(turninToPattern))) {
                    const questName = match[1];
                    const npcName = match[2];
                    
                    const step = {
                        action: 'turnin',
                        name: questName,
                        npc: npcName
                    };
                    
                    if (questDatabase[questName]) {
                        step.quest = questDatabase[questName].quest;
                    } else {
                        missingQuests.add(questName);
                        step.note = `Quest data missing for: ${questName}`;
                    }
                    
                    steps.push(step);
                } else if ((match = line.match(killPattern))) {
                    steps.push({
                        action: 'kill',
                        mob: match[1]
                    });
                }
            }
            
            // Koordinaten hinzuf√ºgen
            const coordPattern = /(\d+)\.(\d+)/;
            const coordMatch = line.match(coordPattern);
            if (coordMatch && steps.length > 0) {
                const x = parseFloat(coordMatch[1] + '.' + coordMatch[2].charAt(0));
                const y = parseFloat(coordMatch[2]);
                
                steps.forEach(step => {
                    step.coords = {x, y};
                });
            }
            
            // NPC Koordinaten hinzuf√ºgen
            steps.forEach(step => {
                if (step.npc && !step.coords && npcCoords[step.npc]) {
                    step.coords = npcCoords[step.npc];
                }
            });
            
            return steps;
        }

        function parseGuideText() {
            const text = document.getElementById('guide-input').value;
            const lines = text.split('\n');
            
            parsedSteps = [];
            missingQuests.clear();
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line || line.startsWith('#') || line.startsWith('//')) return;
                
                const steps = parseComplexLine(line);
                steps.forEach(step => {
                    step._sourceLine = index + 1;
                    step._sourceText = line;
                });
                
                parsedSteps.push(...steps);
            });
            
            updatePreview();
            updateMissingQuests();
            updateStats();
        }

        function updatePreview() {
            const preview = document.getElementById('quest-preview');
            preview.innerHTML = '';
            
            parsedSteps.forEach((step, index) => {
                const div = document.createElement('div');
                div.style.margin = '5px 0';
                div.style.padding = '8px';
                div.style.backgroundColor = step.note ? '#fff3cd' : '#d4edda';
                div.style.border = '1px solid ' + (step.note ? '#ffeaa7' : '#c3e6cb');
                div.style.borderRadius = '4px';
                div.style.fontSize = '12px';
                
                let text = `${index + 1}. ${step.action}`;
                if (step.quest) text += ` [${step.quest}]`;
                if (step.name) text += ` - ${step.name}`;
                if (step.npc) text += ` (${step.npc})`;
                if (step.mob) text += ` - Kill: ${step.mob}`;
                if (step.coords) text += ` [${step.coords.x}, ${step.coords.y}]`;
                if (step.note) text += ` ‚ö†Ô∏è ${step.note}`;
                
                div.textContent = text;
                preview.appendChild(div);
            });
        }

        function updateMissingQuests() {
            const container = document.getElementById('missing-quests');
            container.innerHTML = '';
            
            if (missingQuests.size === 0) {
                container.innerHTML = '<p style="color: green;">‚úÖ Alle Quests gefunden!</p>';
                return;
            }
            
            missingQuests.forEach(questName => {
                const div = document.createElement('div');
                div.style.margin = '5px 0';
                div.style.padding = '5px';
                div.style.backgroundColor = '#f8d7da';
                div.style.border = '1px solid #f5c6cb';
                div.style.borderRadius = '4px';
                div.textContent = `‚ùå ${questName}`;
                container.appendChild(div);
            });
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const totalSteps = parsedSteps.length;
            const questSteps = parsedSteps.filter(s => s.quest).length;
            const missingData = parsedSteps.filter(s => s.note).length;
            
            stats.innerHTML = `
                <strong>üìä Statistiken:</strong><br>
                Gesamt Steps: ${totalSteps}<br>
                Mit Quest-ID: ${questSteps}<br>
                Fehlende Daten: ${missingData}<br>
                Vollst√§ndigkeit: ${Math.round((questSteps/totalSteps)*100)}%
            `;
        }

        function generateLua() {
            if (parsedSteps.length === 0) {
                alert('Bitte zuerst Guide-Text parsen!');
                return;
            }
            
            let lua = '-- Generated Guide\nLevelingGuide = {\n  steps = {\n';
            
            parsedSteps.forEach((step, index) => {
                lua += '    { ';
                
                const parts = [];
                parts.push(`action="${step.action}"`);
                
                if (step.quest) parts.push(`quest=${step.quest}`);
                if (step.name) parts.push(`name="${step.name}"`);
                if (step.npc) parts.push(`npc="${step.npc}"`);
                if (step.mob) parts.push(`mob="${step.mob}"`);
                if (step.item) parts.push(`item="${step.item}"`);
                
                if (step.coords) {
                    parts.push(`coords={x=${step.coords.x}, y=${step.coords.y}}`);
                }
                
                if (step.note) parts.push(`note="${step.note}"`);
                
                lua += parts.join(', ');
                lua += ' }';
                
                if (index < parsedSteps.length - 1) lua += ',';
                
                if (step._sourceText) {
                    lua += `  -- ${step._sourceText}`;
                }
                
                lua += '\n';
            });
            
            lua += '  }\n}';
            
            document.getElementById('lua-output').value = lua;
        }

        function loadExample() {
            const example = `Turn in "Fire Taboo" , accept Blisters on The Land.
Accept [Daily Delivery] from [Einar Stonegrip].
Turn in "The Greenwarden" to [Rethiel the Greenwarden], accept [Tramping Paws].
Kill 15 [Mosshide Gnolls] at 61.58.
At 35.42 enter the Whelgar's Excavation Site.
Go up and turn in "Ormer's Revenge", accept the next part.
Kill 10 [Mottled Raptors] and 8 [Mottled Screechers].`;
            
            document.getElementById('guide-input').value = example;
        }

        function clearInput() {
            document.getElementById('guide-input').value = '';
            document.getElementById('lua-output').value = '';
            document.getElementById('quest-preview').innerHTML = '';
            document.getElementById('missing-quests').innerHTML = '';
            document.getElementById('stats').innerHTML = '';
            parsedSteps = [];
            missingQuests.clear();
        }

        function exportGuide() {
            const lua = document.getElementById('lua-output').value;
            if (!lua) {
                alert('Bitte zuerst Lua Code generieren!');
                return;
            }
            
            const blob = new Blob([lua], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'guide.lua';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const lua = document.getElementById('lua-output').value;
            if (!lua) {
                alert('Bitte zuerst Lua Code generieren!');
                return;
            }
            
            navigator.clipboard.writeText(lua).then(() => {
                alert('‚úÖ Lua Code in Zwischenablage kopiert!');
            });
        }

        function addMissingQuest() {
            const questName = prompt('Quest Name:');
            const questId = prompt('Quest ID:');
            const npcName = prompt('NPC Name:');
            
            if (questName && questId && npcName) {
                questDatabase[questName] = {
                    quest: parseInt(questId),
                    npc: npcName
                };
                
                missingQuests.delete(questName);
                parseGuideText(); // Re-parse with new data
                alert(`‚úÖ Quest "${questName}" hinzugef√ºgt!`);
            }
        }
    </script>
</body>
</html>
